<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover"
    />
    <title>EBECO — Bienvenida</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="styles.css" />
    <style>
      .btn[disabled] {
        opacity: 0.6;
        pointer-events: none;
      }
      .hint {
        font-size: 0.9rem;
        opacity: 0.8;
        margin-top: 8px;
      }
      .btn--ghost {
        background: transparent;
        border: 1px solid #225d26;
        color: #225d26;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.2s ease, color 0.2s ease;
      }
      .btn--ghost:hover {
        background: #225d26;
        color: #fff;
      }
      .actions {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }
    </style>
  </head>
  <body class="app">
    <main class="screen screen--center" role="main">
      <section class="card card--welcome" aria-labelledby="welcome-title">
        <div class="brand">
          <img
            src="assets/logo-ebeco.svg"
            alt="Logo EBECO"
            class="brand__logo"
            onerror="this.src='assets/logo-ebeco.png'"
          />
          <h1 id="welcome-title" class="brand__title">EBECO</h1>
        </div>

        <!-- Saludo (solo si hay sesión) -->
        <div
          id="userBar"
          class="welcome"
          style="display: none; margin-bottom: 0.5rem"
        >
          <p class="welcome__subtitle" id="userGreeting" style="margin: 0"></p>
        </div>

        <div class="welcome">
          <h2 class="welcome__headline">¡Bienvenido!</h2>
          <p class="welcome__subtitle">
            Protege tu bicicleta con la solución eco-segura con precios
            accesibles.
          </p>
          <p
            class="welcome__subtitle"
            style="font-weight: bold; padding-top: 1rem"
          >
            Inicia sesión para ver los planes
          </p>
        </div>

        <div class="actions">
          <!-- Solo cambia la etiqueta: Comenzar -> Iniciar sesión -->
          <button
            id="btnStart"
            class="btn btn--primary btn--lg"
            aria-label="Iniciar sesión"
          >
            Iniciar sesión
          </button>

          <!-- NUEVO: Entrar como invitado (no elimina nada previo) -->
          <button
            id="btnGuest"
            class="btn btn--secondary btn--lg"
            aria-label="Entrar como invitado"
            style="background-color: dodgerblue"
          >
            Entrar como invitado
          </button>

          <div id="msg" class="hint" aria-live="polite">Sin conexión</div>
        </div>
      </section>

      <footer class="footer">
        <small>© <span id="year"></span> EBECO</small>
      </footer>

      <!-- Botón global para cerrar sesión (solo si hay sesión) -->
      <div style="margin-top: 1rem; text-align: center">
        <button id="logoutBtn" class="btn--ghost" style="display: none">
          Cerrar sesión
        </button>
      </div>
    </main>

    <script src="./app.js"></script>
    <!-- Fallback por si app.js no carga -->
    <script>
      window.EBECO = window.EBECO || {
        isAuthed: () => false,
        getCurrentUser: () => null,
        logoutUser: () => {},
      };
    </script>
    <script>
      document.getElementById("year").textContent = new Date().getFullYear();

      const btn = document.getElementById("btnStart");
      const btnGuest = document.getElementById("btnGuest");
      const msg = document.getElementById("msg");
      const logoutBtn = document.getElementById("logoutBtn");
      const userBar = document.getElementById("userBar");
      const userGreeting = document.getElementById("userGreeting");

      // Si hay sesión, muestra saludo y botón salir (MISMO COMPORTAMIENTO)
      (function hydrateUserBar() {
        if (EBECO.isAuthed && EBECO.isAuthed()) {
          const user = EBECO.getCurrentUser ? EBECO.getCurrentUser() : null;
          if (user) {
            userGreeting.textContent = `Hola, ${user.name}`;
            userBar.style.display = "block";
            logoutBtn.style.display = "inline-flex";
          }
        }
      })();

      // Cerrar sesión (MISMO)
      logoutBtn.addEventListener("click", () => {
        EBECO.logoutUser && EBECO.logoutUser();
        localStorage.removeItem("ebeco-guest");
        alert("Sesión cerrada correctamente.");
        location.reload();
      });

      function setMsg(t) {
        msg.textContent = t;
      }

      // === MISMO handleStart que ya tenías (NO BORRADO) ===
      async function handleStart() {
        // Si NO está autenticado, directo a login
        if (!EBECO.isAuthed || !EBECO.isAuthed()) {
          window.location.href = "login.html";
          return;
        }

        // Si está autenticado: intenta permiso Web Serial y continúa
        const NEXT_URL = "seleccionar-accion.html";

        if (!("serial" in navigator)) {
          setMsg(
            "Tu navegador no soporta Web Serial. Continuando sin hardware…"
          );
          window.location.href = NEXT_URL;
          return;
        }

        btn.disabled = true;
        setMsg("Solicitando acceso al puerto…");
        try {
          const grantedPorts = await navigator.serial.getPorts();
          if (grantedPorts.length > 0) {
            localStorage.setItem("ebeco-serial-permission", "granted");
          } else {
            const port = await navigator.serial.requestPort();
            if (port)
              localStorage.setItem("ebeco-serial-permission", "granted");
          }
        } catch (err) {
          console.warn("Permiso no concedido:", err?.name || err);
          localStorage.removeItem("ebeco-serial-permission");
        } finally {
          setMsg("Continuando…");
          window.location.href = NEXT_URL;
        }
      }

      // === NUEVO: Invitado SIN tocar el flujo anterior ===
      async function handleGuest() {
        // Marca de invitado (útil si quieres limitar funciones luego)
        localStorage.setItem("ebeco-guest", "1");
        const NEXT_URL = "seleccionar-accion.html";

        // Intento NO BLOQUEANTE de permiso Web Serial (opcional)
        if ("serial" in navigator) {
          try {
            setMsg("Comprobando permisos de puerto…");
            const granted = await navigator.serial.getPorts();
            if (!granted.length) {
              await navigator.serial.requestPort();
            }
            localStorage.setItem("ebeco-serial-permission", "granted");
          } catch {
            // si cancela o falla, seguimos como invitado igual
          }
        } else {
          setMsg(
            "Tu navegador no soporta Web Serial. Continuando sin hardware…"
          );
        }

        window.location.href = NEXT_URL;
      }

      document
        .getElementById("btnStart")
        .addEventListener("click", handleStart);
      document
        .getElementById("btnGuest")
        .addEventListener("click", handleGuest);
    </script>
  </body>
</html>
