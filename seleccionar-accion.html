<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover"
    />
    <title>EBECO ‚Äî Seleccionar acci√≥n</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body class="app">
    <main class="screen">
      <!-- Topbar reutilizable -->
      <header class="topbar" role="banner">
        <button
          class="btn btn--ghost"
          onclick="history.back()"
          aria-label="Volver"
        >
          ‚Üê
        </button>
        <h1 class="topbar__title" style="flex: 1">EBECO</h1>
        <img
          src="assets/logo-ebeco.png"
          alt="Logo EBECO"
          class="brand__logo"
          style="
            width: 80px;
            height: 80px;
            object-fit: contain;
            border-radius: 50%;
            background: transparent;
            box-shadow: none;
          "
        />
      </header>

      <section
        class="card u-grid"
        aria-labelledby="acciones-title"
        style="margin-top: 1rem"
      >
        <h2 id="acciones-title" style="margin: 0">Seleccionar la acci√≥n</h2>

        <nav class="list" aria-label="Acciones principales">
          <!-- Estacionar bicicleta -->
          <a class="item" href="verify-facial.html">
            <div style="display: flex; align-items: center; gap: 0.75rem">
              <!--<span aria-hidden="true" style="font-size:1.25rem">üîí</span>-->
              <div>
                <div class="u-bold">Estacionar bicicleta</div>
                <small class="u-muted"
                  >Bloquea y registra tu bici en un slot</small
                >
              </div>
            </div>
            <span aria-hidden="true">‚Ä∫</span>
          </a>

          <!-- Liberar bicicleta -->
          <a class="item" href="metodo-pago.html">
            <div style="display: flex; align-items: center; gap: 0.75rem">
              <!--<span aria-hidden="true" style="font-size:1.25rem">üîì</span>-->
              <div>
                <div class="u-bold">Liberar bicicleta</div>
                <small class="u-muted">Desbloquea y realiza el pago</small>
              </div>
            </div>
            <span aria-hidden="true">‚Ä∫</span>
          </a>

          <!-- Historial -->
          <a class="item" href="historial.html">
            <div style="display: flex; align-items: center; gap: 0.75rem">
              <!--<span aria-hidden="true" style="font-size:1.25rem">üïò</span>-->
              <div>
                <div class="u-bold">Historial</div>
                <small class="u-muted">Ingresos, salidas y pagos</small>
              </div>
            </div>
            <span aria-hidden="true">‚Ä∫</span>
          </a>
        </nav>
      </section>
    </main>
    <script>
      let port, reader, writer;

      async function openSerialIfGranted() {
        const msgEl = document.getElementById("serialStatus");
        function setMsg(t) {
          if (msgEl) msgEl.textContent = t;
        }

        if (!("serial" in navigator)) {
          setMsg?.("Web Serial no disponible. Usa Chrome/Edge.");
          return;
        }

        try {
          const granted =
            localStorage.getItem("ebeco-serial-permission") === "granted";
          if (!granted) {
            setMsg?.("Sin permiso de puerto. Vuelve a Inicio.");
            return;
          }

          const ports = await navigator.serial.getPorts();
          if (ports.length === 0) {
            setMsg?.("No se encontr√≥ un puerto concedido. Vuelve a Inicio.");
            return;
          }

          port = ports[0];
          await port.open({ baudRate: 115200 });
          setMsg?.("Conectado por Serial.");

          // Preparar writer/reader si los necesitas en esta pantalla:
          writer = port.writable?.getWriter?.();
          const textDecoder = new TextDecoder();

          (async () => {
            try {
              const r = port.readable.getReader();
              while (true) {
                const { value, done } = await r.read();
                if (done) break;
                if (value) {
                  const msg = textDecoder.decode(value);
                  console.log("Arduino:", msg);
                }
              }
              r.releaseLock();
            } catch (e) {
              console.warn(e);
            }
          })();

          // Ejemplo: funci√≥n para enviar l√≠neas
          window.ebecoSend = async (text) => {
            if (!writer) return;
            const data = new TextEncoder().encode(text + "\n");
            await writer.write(data);
          };

          // Cierre ordenado al salir
          window.addEventListener("beforeunload", async () => {
            try {
              if (writer) {
                writer.releaseLock();
                writer = null;
              }
              if (port) {
                await port.close();
                port = null;
              }
            } catch {}
          });
        } catch (err) {
          console.error(err);
          setMsg?.("Error al abrir el puerto: " + err.message);
        }
      }

      // Llama al iniciar la pantalla
      document.addEventListener("DOMContentLoaded", openSerialIfGranted);
    </script>

    <!-- En tu HTML puedes tener un peque√±o estado -->
    <div
      id="serialStatus"
      style="font-size: 0.9rem; opacity: 0.8; margin-top: 8px"
    >
      Conectando‚Ä¶
    </div>
  </body>
</html>
