<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover"
    />
    <title>EBECO ‚Äî Pago con Yape</title>
    <link rel="stylesheet" href="styles.css" />
    <style>
      body {
        font-family: system-ui, sans-serif;
        background: #f8fafc;
        margin: 0;
        display: flex;
        flex-direction: column;
        min-height: 100vh;
      }
      .topbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: #166534; /* verde EBECO */
        padding: 0.75rem 1rem;
        color: #fff;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
      }
      .topbar__title {
        flex: 1;
        text-align: center;
        font-weight: 600;
        font-size: 1.2rem;
        color: #fff;
      }
      .btn--ghost {
        background: none;
        border: none;
        font-size: 1.25rem;
        color: #fff;
        cursor: pointer;
      }
      .brand__logo {
        width: 40px;
        height: 40px;
        object-fit: contain;
        border-radius: 50%;
      }
      main.screen {
        flex: 1;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        padding: 2rem 1rem;
      }
      .card {
        background: white;
        border-radius: 1rem;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        width: 320px;
        text-align: center;
        padding: 1.5rem;
      }
      h2 {
        color: #166534;
        font-size: 1.4rem;
        margin-bottom: 0.75rem;
      }
      img.qr {
        width: 240px;
        height: 240px;
        object-fit: contain;
        border-radius: 0.75rem;
        margin: 1rem 0;
      }
      .amount {
        font-size: 1.8rem;
        font-weight: 700;
        color: #065f46;
        margin-bottom: 1.2rem;
      }
      .btn {
        display: block;
        width: 100%;
        padding: 0.9rem;
        border: none;
        border-radius: 0.75rem;
        font-size: 1rem;
        font-weight: 600;
        color: white;
        cursor: pointer;
        transition: background 0.2s;
        margin-bottom: 0.5rem;
      }
      .btn--primary { background-color: #16a34a; }
      .btn--primary:hover { background-color: #15803d; }
      .btn--danger { background-color: #dc2626; }
      .btn--danger:hover { background-color: #b91c1c; }
      #serialStatus {
        font-size: .9rem;
        color: #64748b;
        margin-top: .5rem;
      }
    </style>
  </head>

  <body class="app">
    <!-- Topbar -->
    <header class="topbar" role="banner">
      <button class="btn btn--ghost" onclick="history.back()" aria-label="Volver">‚Üê</button>
      <h1 class="topbar__title" style="flex: 1">EBECO</h1>
      <img src="assets/logo-ebeco.png" alt="Logo EBECO" class="brand__logo" />
    </header>

    <!-- Contenido principal -->
    <main class="screen">
      <div class="card">
        <h2>Pago con Yape</h2>
        <img src="assets/yape-pago.jpeg" alt="QR Yape - EBECO" class="qr" />
        <div class="amount" id="amountLabel">S/. 3.00</div>

        <button class="btn btn--primary" id="btnSimular">Simular pago Yape</button>
        <button class="btn btn--danger" onclick="history.back()">Cancelar</button>

        <!-- üëá Antes no exist√≠a; lo usa setStatus -->
        <div id="serialStatus">Preparando sistema‚Ä¶</div>
      </div>
    </main>

    <!-- Utilitario de historial -->
    <script>
      window.EBECO = window.EBECO || {};
      (function () {
        const KEY = 'ebeco-history';
        function load() { try { return JSON.parse(localStorage.getItem(KEY) || '[]'); } catch { return []; } }
        function save(list) { localStorage.setItem(KEY, JSON.stringify(list)); }
        function add({ type, place, at = new Date().toISOString(), amount = null }) {
          const list = load();
          list.unshift({
            id: crypto?.randomUUID ? crypto.randomUUID() : (Date.now() + '-' + Math.random()),
            type, place: place || 'Sede desconocida', at, amount
          });
          save(list.slice(0, 200));
        }
        function get() { return load(); }
        function clear() { save([]); }
        EBECO.History = { add, get, clear };
      })();
      function getPlaceContext() {
        const p = new URLSearchParams(location.search);
        if (p.get('place')) return p.get('place');
        const c = localStorage.getItem('ebeco-place');
        return c || 'M√≥dulo A ‚Äî UCSM';
      }
      function getAmountNumber() {
        const raw = document.getElementById('amountLabel')?.textContent || '0';
        const num = parseFloat(raw.replace(/[^\d.,-]/g, '').replace(',', '.'));
        return isNaN(num) ? 0 : num;
      }
    </script>

    <script>
      // ==========================
      //   Web Serial robusto
      // ==========================
      let port = null, writer = null, reader = null, textDecoder = null;
      let openPromise = null; // üîí evita open() concurrentes
      let navTimer = null;    // fallback de navegaci√≥n
      let isConnected = false;
      let loggedRelease = false; // üëà evita doble registro

      const statusEl = document.getElementById("serialStatus");
      const btnSimular = document.getElementById("btnSimular");

      function setStatus(t, tone = "muted") {
        if (!statusEl) return; // por seguridad
        statusEl.textContent = t;
        statusEl.style.color =
          tone === "ok" ? "#16a34a" : tone === "err" ? "#b91c1c" : "#64748b";
      }

      // Conexi√≥n al puerto serial
      async function ensureConnected({ forceDialog = false } = {}) {
        if (!("serial" in navigator)) {
          setStatus("Web Serial no disponible (usa Chrome/Edge).", "err");
          return false;
        }
        if (openPromise) { try { await openPromise; } catch {} return !!(port && port.readable && port.writable); }

        openPromise = (async () => {
          try {
            if (!port) {
              const ports = await navigator.serial.getPorts();
              if (ports.length) {
                port = ports[0];
              } else if (forceDialog) {
                const filters = [
                  { usbVendorId: 0x2341 }, // Arduino LLC
                  { usbVendorId: 0x2a03 }, // Arduino.org
                  { usbVendorId: 0x1a86 }, // CH340
                  { usbVendorId: 0x10c4 }, // CP210x
                ];
                port = await navigator.serial.requestPort({ filters });
              } else {
                setStatus("Sin permiso previo. Pulsa ‚ÄúConectar dispositivo‚Äù.");
                return false;
              }
            }

            const needsOpen = !(port.readable && port.writable);
            if (needsOpen) {
              await port.open({ baudRate: 115200 });
              await new Promise((r) => setTimeout(r, 1200)); // warmup
              writer = port.writable.getWriter();
              textDecoder = new TextDecoder();
              reader = port.readable.getReader();
              readLoop().catch(() => {});
            }

            setStatus("‚úÖ Sistema conectado.", "ok");
            isConnected = true;
            return true;
          } catch (e) {
            console.error("[EBECO] ensureConnected open error:", e);
            setStatus("No se pudo abrir el puerto. ¬øIDE u otra pesta√±a lo usa?", "err");
            port = null; isConnected = false;
            return false;
          } finally {
            setTimeout(() => { openPromise = null; }, 0);
          }
        })();

        return await openPromise;
      }

      // Lector de puerto serial para obtener respuesta de Arduino
      async function readLoop() {
        let buf = "";
        while (true) {
          const { value, done } = await reader.read();
          if (done) break;
          if (!value) continue;

          buf += textDecoder.decode(value);
          const lines = buf.split(/\r?\n/);
          buf = lines.pop() || "";

          for (const raw of lines) {
            const line = raw.trim();
            if (!line) continue;

            console.log("Recibido desde Arduino:", line);

            // Si la respuesta es OPEN, redirige y REGISTRA (una sola vez)
            if (/OPEN/i.test(line)) {
              setStatus("Candado abierto (verde).", "ok");

              if (!loggedRelease) {
                try {
                  EBECO.History.add({
                    type: 'liberar',
                    place: getPlaceContext(),
                    amount: getAmountNumber()
                  });
                  loggedRelease = true;
                } catch (e) {
                  console.warn('No se pudo registrar el historial (liberar: OPEN):', e);
                }
              }

              if (navTimer) { clearTimeout(navTimer); navTimer = null; }
              setTimeout(() => { window.location.href = "bicicleta-desbloqueada.html"; }, 300);
            }
            if (/CLOSE/i.test(line)) {
              setStatus("Candado cerrado (rojo).");
            }
          }
        }
      }

      // Enviar comando de apertura al Arduino
      async function sendLine(s) {
        if (!writer) throw new Error("No hay conexi√≥n.");
        const data = new TextEncoder().encode(s + "\n");
        await writer.write(data);
        console.log("[EBECO] >", s);
      }

      // === Simulaci√≥n de pago con Yape ===
      btnSimular.addEventListener("click", async () => {
        alert("‚úÖ Pago Yape simulado correctamente.\nGracias por su pago de " + document.getElementById('amountLabel').textContent + ".");

        // 1) Registrar la liberaci√≥n de inmediato (sin esperar Arduino)
        if (!loggedRelease) {
          try {
            EBECO.History.add({
              type: "liberar",
              place: getPlaceContext(),
              amount: getAmountNumber()
            });
            loggedRelease = true;
          } catch (e) {
            console.warn('No se pudo registrar historial (simulaci√≥n Yape):', e);
          }
        }

        // 2) Redirigir ya (experiencia r√°pida)
        window.location.href = "bicicleta-desbloqueada.html";

        // 3) (Opcional) intentar mandar OPEN al Arduino si est√° disponible
        const ok = await ensureConnected();
        if (!ok || !isConnected) {
          setStatus("No se pudo conectar. (Simulaci√≥n completada)", "muted");
          return;
        }

        setStatus("üîì Abriendo seguro...");
        try {
          await sendLine("o");
        } catch {
          setStatus("No se pudo enviar el comando. Cierra el Monitor Serial del IDE.", "err");
          return;
        }

        // Fallback por si no llega OPEN (no afecta porque ya redirigimos)
        if (navTimer) clearTimeout(navTimer);
        navTimer = setTimeout(() => {
          console.warn("[EBECO] Fallback: navegar sin ACK OPEN");
          window.location.href = "bicicleta-desbloqueada.html";
        }, 1500);
      });
    </script>
  </body>
</html>
