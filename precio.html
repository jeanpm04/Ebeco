<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>EBECO ‚Äî Precio de estacionamiento</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body class="app">
  <main class="screen">
    <!-- Topbar -->
    <header class="topbar" role="banner">
      <button class="btn btn--ghost" onclick="history.back()" aria-label="Volver">‚Üê</button>
      <h1 class="topbar__title" style="flex:1">EBECO</h1>
      <img src="assets/logo-ebeco.svg" alt="Logo EBECO" class="brand__logo"
           style="width:40px;height:40px;object-fit:contain;border-radius:50%;background:transparent;box-shadow:none" />
    </header>

    <!-- Card principal con precio -->
    <section class="card u-grid stack-top" aria-labelledby="price-title">
      <h2 id="price-title">Precio de estacionamiento</h2>

      <div class="u-grid" style="text-align:center">
        <div class="chip chip--info" style="font-size:1.25rem;justify-content:center;gap:.75rem">
          <span class="dot" aria-hidden="true"></span>
          Estacionamiento por 1 hora
        </div>
        <h3 style="font-size:2.5rem; font-weight:700; margin: 1rem 0;">
          S/. 3.00
        </h3>

        <p class="u-muted">Hora actual: <span id="current-time"></span></p>
        <p class="u-muted">Confirmaci√≥n del estacionamiento de la bicicleta.</p>
      </div>

      <!-- Botones -->
      <div class="actions">
        <a id="btnConfirm" class="btn btn--primary btn--lg" href="bicicleta-protegida.html">
          Confirmar estacionar bicicleta
        </a>
        <a class="btn btn--danger btn--lg" href="seleccionar-accion.html">Cancelar</a>
      </div>

      <div id="serialStatus" class="u-muted" style="margin-top:1rem;text-align:center">Conectando al sistema...</div>
    </section>
  </main>

  <script>
    // Mostrar hora actual
    function getCurrentTime() {
      const now = new Date();
      const hours = String(now.getHours()).padStart(2, '0');
      const minutes = String(now.getMinutes()).padStart(2, '0');
      const seconds = String(now.getSeconds()).padStart(2, '0');
      document.getElementById('current-time').textContent = `${hours}:${minutes}:${seconds}`;
    }
    setInterval(getCurrentTime, 1000);
    getCurrentTime();

    // ==========================
    // CONEXI√ìN SERIAL (EBECO)
    // ==========================
    let port, writer;
    const statusEl = document.getElementById('serialStatus');
    const btnConfirm = document.getElementById('btnConfirm');

    function setStatus(t) { statusEl.textContent = t; }

    async function openSerialIfGranted() {
      if (!('serial' in navigator)) {
        setStatus('Tu navegador no soporta Web Serial.');
        return;
      }

      try {
        const granted = localStorage.getItem('ebeco-serial-permission') === 'granted';
        if (!granted) {
          setStatus('Sin permiso de conexi√≥n. Regresa al inicio.');
          btnConfirm.disabled = true;
          return;
        }

        const ports = await navigator.serial.getPorts();
        if (ports.length === 0) {
          setStatus('No se detect√≥ puerto autorizado. Regresa al inicio.');
          btnConfirm.disabled = true;
          return;
        }

        port = ports[0];
        await port.open({ baudRate: 115200 });
        writer = port.writable.getWriter();
        setStatus('‚úÖ Sistema conectado.');

        // Cierre ordenado si el usuario se va
        window.addEventListener('beforeunload', async () => {
          try {
            writer.releaseLock();
            await port.close();
          } catch {}
        });

      } catch (err) {
        console.error(err);
        setStatus('Error al abrir puerto: ' + err.message);
        btnConfirm.disabled = true;
      }
    }

    // Enviar comando al Arduino
    async function ebecoSend(cmd) {
      if (!writer) return alert('No hay conexi√≥n con el sistema.');
      const data = new TextEncoder().encode(cmd + '\n');
      await writer.write(data);
    }

    // Acci√≥n al confirmar
    btnConfirm.addEventListener('click', async () => {
      setStatus('üîí Cerrando seguro...');
      await ebecoSend('c'); // comando "cerrar"
      setTimeout(() => {
        window.location.href = 'bicicleta-protegida.html';
      }, 1000);
    });

    // Abrir el puerto al cargar la p√°gina
    openSerialIfGranted();
    
  </script>
  
</body>
</html>
