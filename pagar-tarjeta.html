<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>EBECO ‚Äî Pagar con tarjeta</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body class="app">
  <main class="screen">
    <!-- Topbar -->
    <header class="topbar" role="banner">
      <button class="btn btn--ghost" onclick="history.back()" aria-label="Volver">‚Üê</button>
      <h1 class="topbar__title" style="flex:1">EBECO</h1>
      <img src="assets/logo-ebeco.png" 
           alt="Logo EBECO" 
           class="brand__logo"
           style="width:80px;height:80px;object-fit:contain;border-radius:50%;background:transparent;box-shadow:none" />
    </header>

    <!-- Card principal con formulario -->
    <section class="card u-grid stack-top" aria-labelledby="card-payment-title">
      <h2 id="card-payment-title">Pagar con tarjeta</h2>

      <!-- Formulario de pago -->
      <!-- Importante: quitamos action/method reales y navegamos por JS para que funcione offline -->
      <form id="payment-form" class="u-grid" novalidate>
        <!-- Titular de la tarjeta -->
        <div class="field">
          <label for="cardholder" class="label">Titular de la tarjeta</label>
          <input type="text" id="cardholder" name="cardholder" class="input" placeholder="Nombre completo" required />
        </div>

        <!-- N√∫mero de tarjeta -->
        <div class="field">
          <label for="card-number" class="label">N√∫mero de tarjeta</label>
          <input type="text" id="card-number" name="card-number" class="input" placeholder="1234 5678 9012 3456" required />
        </div>

        <!-- Fecha de vencimiento -->
        <div class="field">
          <label for="expiration" class="label">Fecha de vencimiento</label>
          <input type="month" id="expiration" name="expiration" class="input" required />
        </div>

        <!-- CVV -->
        <div class="field">
          <label for="cvv" class="label">CVV</label>
          <input type="text" id="cvv" name="cvv" class="input" placeholder="123" required />
        </div>

        <!-- Monto total a pagar -->
        <div class="field">
          <label for="total-amount" class="label">Monto a pagar</label>
          <input type="text" id="total-amount" name="total-amount" class="input" value="S/. 3.00" readonly />
        </div>

        <!-- Bot√≥n de confirmar pago -->
        <div class="actions">
          <button type="submit" class="btn btn--primary btn--lg">Confirmar pago</button>
        </div>

        <div id="serialStatus" class="u-muted" style="margin-top:1rem;text-align:center">Preparando sistema‚Ä¶</div>
      </form>
    </section>
  </main>

  <script>
    // ==========================
    // SERIAL EBECO: abrir si hay permiso previo
    // ==========================
    let port = null, writer = null;

    function setStatus(t){
      const el = document.getElementById('serialStatus');
      if (el) el.textContent = t;
    }

    async function openSerialIfGranted(){
      if (!('serial' in navigator)) {
        setStatus('Web Serial no disponible (Chrome/Edge). Continuar√° sin hardware.');
        return;
      }
      try {
        const granted = localStorage.getItem('ebeco-serial-permission') === 'granted';
        if (!granted) {
          setStatus('Sin permiso de puerto. Continuar√° sin hardware.');
          return;
        }
        const ports = await navigator.serial.getPorts();
        if (ports.length === 0) {
          setStatus('No se detect√≥ puerto autorizado. Continuar√° sin hardware.');
          return;
        }
        port = ports[0];
        await port.open({ baudRate: 115200 });
        writer = port.writable.getWriter();
        setStatus('‚úÖ Sistema conectado.');
        // Cierre ordenado
        window.addEventListener('beforeunload', async () => {
          try { if (writer) writer.releaseLock(); } catch {}
          try { if (port) await port.close(); } catch {}
        });
      } catch (err) {
        console.warn(err);
        setStatus('No se pudo abrir el puerto. Continuar√° sin hardware.');
      }
    }

    async function ebecoSend(cmd){
      try {
        if (!writer) return; // si no hay conexi√≥n, simplemente no enviamos
        const data = new TextEncoder().encode(cmd + '\n');
        await writer.write(data);
      } catch (e) {
        // Ignorar errores para no bloquear el flujo de pago/navegaci√≥n
      }
    }

    document.addEventListener('DOMContentLoaded', openSerialIfGranted);

    // ==========================
    // FORM: validaci√≥n ligera + abrir y navegar SIEMPRE
    // ==========================
    const form = document.getElementById('payment-form');
    form.addEventListener('submit', async (e) => {
      e.preventDefault(); // evitamos POST real para funcionar en archivo est√°tico
      // Validaci√≥n m√≠nima (puedes mejorarla seg√∫n necesites)
      const nameOk = form.cardholder.value.trim().length > 0;
      const numOk  = form['card-number'].value.replace(/\s+/g,'').length >= 12;
      const cvvOk  = /^\d{3,4}$/.test(form.cvv.value.trim());
      if (!(nameOk && numOk && cvvOk)) {
        setStatus('Revisa los datos de la tarjeta.');
        return;
      }

      setStatus('üîì Abriendo seguro‚Ä¶');
      // Enviar comando "abrir" sin bloquear navegaci√≥n
      ebecoSend('o');

      // Redirigir SIEMPRE a la pr√≥xima pantalla
      setTimeout(() => {
        window.location.href = 'bicicleta-desbloqueada.html';
      }, 600); // breve pausa opcional
    });
  </script>
</body>
</html>
