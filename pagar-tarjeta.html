<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover"
    />
    <title>EBECO ‚Äî Pagar con tarjeta</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body class="app">
    <main class="screen">
      <!-- Topbar -->
      <header class="topbar" role="banner">
        <button
          class="btn btn--ghost"
          onclick="history.back()"
          aria-label="Volver"
        >
          ‚Üê
        </button>
        <h1 class="topbar__title" style="flex: 1">EBECO</h1>
        <img
          src="assets/logo-ebeco.png"
          alt="Logo EBECO"
          class="brand__logo"
          style="
            width: 80px;
            height: 80px;
            object-fit: contain;
            border-radius: 50%;
            background: transparent;
            box-shadow: none;
          "
        />
      </header>

      <!-- Card principal con formulario -->
      <section
        class="card u-grid stack-top"
        aria-labelledby="card-payment-title"
      >
        <h2 id="card-payment-title">Pagar con tarjeta</h2>

        <form id="payment-form" class="u-grid" novalidate>
          <div class="field">
            <label for="cardholder" class="label">Titular de la tarjeta</label>
            <input
              type="text"
              id="cardholder"
              name="cardholder"
              class="input"
              placeholder="Nombre completo"
            />
          </div>

          <div class="field">
            <label for="card-number" class="label">N√∫mero de tarjeta</label>
            <input
              type="text"
              id="card-number"
              name="card-number"
              class="input"
              placeholder="1234 5678 9012 3456"
            />
          </div>

          <div class="field">
            <label for="expiration" class="label">Fecha de vencimiento</label>
            <input
              type="month"
              id="expiration"
              name="expiration"
              class="input"
            />
          </div>

          <div class="field">
            <label for="cvv" class="label">CVV</label>
            <input
              type="text"
              id="cvv"
              name="cvv"
              class="input"
              placeholder="123"
            />
          </div>

          <div class="field">
            <label for="total-amount" class="label">Monto a pagar</label>
            <input
              type="text"
              id="total-amount"
              name="total-amount"
              class="input"
              value="S/. 3.00"
              readonly
            />
          </div>

          <div
            class="actions"
            style="display: flex; flex-direction: column; gap: 0.75rem"
          >
            <button
              id="btnSubmit"
              type="submit"
              class="btn btn--primary btn--lg"
            >
              Confirmar pago
            </button>
            <button
              id="btnConnect"
              type="button"
              class="btn btn--ghost"
              style="display: none"
            >
              Conectar dispositivo
            </button>
          </div>

          <div
            id="serialStatus"
            class="u-muted"
            style="margin-top: 1rem; text-align: center"
          >
            Preparando sistema‚Ä¶
          </div>
        </form>
      </section>
    </main>

    <script>
      // ==========================
      //   Web Serial robusto
      // ==========================
      let port = null,
        writer = null,
        reader = null,
        textDecoder = null;
      let openPromise = null; // üîí evita open() concurrentes
      let navTimer = null; // fallback de navegaci√≥n

      const statusEl = document.getElementById("serialStatus");
      const btnConnect = document.getElementById("btnConnect");
      const form = document.getElementById("payment-form");
      const btnSubmit = document.getElementById("btnSubmit");

      function setStatus(t, tone = "muted") {
        statusEl.textContent = t;
        statusEl.style.color =
          tone === "ok" ? "#16a34a" : tone === "err" ? "#b91c1c" : "#64748b";
      }

      // Lector √∫nico: detecta OPEN/CLOSE del Arduino
      async function readLoop() {
        let buf = "";
        while (true) {
          const { value, done } = await reader.read();
          if (done) break;
          if (!value) continue;

          buf += textDecoder.decode(value);
          const lines = buf.split(/\r?\n/);
          buf = lines.pop() || "";

          for (const raw of lines) {
            const line = raw.trim();
            if (!line) continue;

            if (/OPEN/i.test(line)) {
              setStatus("Candado abierto (verde).", "ok");
              if (navTimer) {
                clearTimeout(navTimer);
                navTimer = null;
              }
              setTimeout(() => {
                window.location.href = "bicicleta-desbloqueada.html";
              }, 300);
            }
            if (/CLOSE/i.test(line)) {
              setStatus("Candado cerrado (rojo).");
            }
          }
        }
      }

      async function sendLine(s) {
        if (!writer) throw new Error("No hay conexi√≥n.");
        const data = new TextEncoder().encode(s + "\n");
        await writer.write(data);
        console.log("[EBECO] >", s);
      }

      // Abre/reusa un puerto concedido; con forceDialog puede forzar chooser
      async function ensureConnected({ forceDialog = false } = {}) {
        if (!("serial" in navigator)) {
          setStatus("Web Serial no disponible (usa Chrome/Edge).", "err");
          return false;
        }

        // Si ya hay una apertura en curso, espera esa misma promesa
        if (openPromise) {
          try {
            await openPromise;
          } catch {}
          return !!(port && port.readable && port.writable);
        }

        // Promesa √∫nica de apertura (candado)
        openPromise = (async () => {
          try {
            // 1) Selecci√≥n/permiso
            if (!port) {
              const ports = await navigator.serial.getPorts();
              if (ports.length) {
                port = ports[0];
              } else if (forceDialog) {
                // Selector con filtros para Arduino/CH340/CP210x
                const filters = [
                  { usbVendorId: 0x2341 }, // Arduino LLC
                  { usbVendorId: 0x2a03 }, // Arduino.org
                  { usbVendorId: 0x1a86 }, // CH340
                  { usbVendorId: 0x10c4 }, // CP210x
                ];
                port = await navigator.serial.requestPort({ filters });
              } else {
                setStatus("Sin permiso previo. Pulsa ‚ÄúConectar dispositivo‚Äù.");
                btnConnect.style.display = "inline-block";
                return false;
              }
            }

            // 2) Abrir si no est√° abierto a√∫n
            const needsOpen = !(port.readable && port.writable);
            if (needsOpen) {
              await port.open({ baudRate: 115200 });
              await new Promise((r) => setTimeout(r, 1200)); // warmup del UNO

              writer = port.writable.getWriter();
              textDecoder = new TextDecoder();
              reader = port.readable.getReader();
              readLoop().catch(() => {});
            }

            setStatus("‚úÖ Sistema conectado.", "ok");
            btnConnect.style.display = "none";

            // Cierre ordenado al salir
            window.addEventListener(
              "beforeunload",
              async () => {
                try {
                  await reader?.cancel?.();
                } catch {}
                try {
                  reader?.releaseLock?.();
                } catch {}
                try {
                  writer?.releaseLock?.();
                } catch {}
                try {
                  await port?.close?.();
                } catch {}
              },
              { once: true }
            );

            return true;
          } catch (e) {
            console.error("[EBECO] ensureConnected open error:", e);
            setStatus(
              "No se pudo abrir el puerto. ¬øIDE u otra pesta√±a lo usa?",
              "err"
            );
            // Forzar re-selecci√≥n en el pr√≥ximo intento
            port = null;
            return false;
          } finally {
            // libera el candado (defer para evitar carrera inmediata)
            setTimeout(() => {
              openPromise = null;
            }, 0);
          }
        })();

        return await openPromise;
      }

      // Conecta autom√°ticamente si ya hab√≠a permiso (no abre di√°logo)
      document.addEventListener("DOMContentLoaded", () => {
        ensureConnected(); // intento silencioso
      });

      // Bot√≥n para pedir puerto si no hay permiso previo (con filtros)
      btnConnect.addEventListener("click", async () => {
        btnConnect.disabled = true;
        setStatus("Abriendo selector de puertos‚Ä¶");
        try {
          const filters = [
            { usbVendorId: 0x2341 }, // Arduino LLC
            { usbVendorId: 0x2a03 }, // Arduino.org
            { usbVendorId: 0x1a86 }, // CH340
            { usbVendorId: 0x10c4 }, // CP210x
          ];
          // Forzamos chooser y guardamos port elegido
          port = await navigator.serial.requestPort({ filters });

          setStatus("Conectando al dispositivo‚Ä¶");
          const ok = await ensureConnected(); // ya con 'port' definido
          if (ok) {
            const info = port.getInfo?.() || {};
            setStatus(
              `‚úÖ Conectado (vendor 0x${(info.usbVendorId || 0).toString(
                16
              )} product 0x${(info.usbProductId || 0).toString(16)})`,
              "ok"
            );
            btnConnect.style.display = "none";
          } else {
            setStatus(
              "No se pudo conectar. Verifica que el IDE no tenga abierto el Monitor Serial.",
              "err"
            );
            btnConnect.disabled = false;
          }
        } catch (e) {
          setStatus("Selecci√≥n cancelada. Vuelve a intentar.", "muted");
          btnConnect.disabled = false;
        }
      });

      // ==========================
      //   Formulario (sin validaci√≥n real)
      // ==========================
      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        // Evita doble clic mientras conecta/manda
        btnSubmit.disabled = true;

        // Asegura conexi√≥n: primero silencioso, luego con di√°logo si hace falta
        setStatus("Conectando al dispositivo‚Ä¶");
        let ok = await ensureConnected();
        if (!ok) ok = await ensureConnected({ forceDialog: true });
        if (!ok) {
          setStatus("No se pudo conectar. Usa ‚ÄúConectar dispositivo‚Äù.", "err");
          btnSubmit.disabled = false;
          return;
        }

        // Enviar comando ABRIR (o)
        setStatus("üîì Abriendo seguro‚Ä¶");
        try {
          await sendLine("o"); // abrir (LED verde)
        } catch {
          setStatus(
            "No se pudo enviar el comando. Cierra el Monitor Serial del IDE.",
            "err"
          );
          btnSubmit.disabled = false;
          return;
        }

        // Fallback: si no llega OPEN en 1.5 s, navegar igual
        if (navTimer) clearTimeout(navTimer);
        navTimer = setTimeout(() => {
          console.warn("[EBECO] Fallback: navegar sin ACK OPEN");
          window.location.href = "bicicleta-desbloqueada.html";
        }, 1500);

        // Rehabilitar por si no navega (si navega no importa)
        setTimeout(() => {
          btnSubmit.disabled = false;
        }, 2000);
      });
    </script>
  </body>
</html>
