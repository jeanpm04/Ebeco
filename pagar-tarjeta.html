<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>EBECO ‚Äî Pagar con tarjeta</title>
    <link rel="stylesheet" href="styles.css" />
    <style>
      .hint{opacity:.85;font-size:.9rem}
      .fieldset{border:1px solid #e6e6e6;border-radius:10px;padding:.75rem 1rem;margin:.75rem 0}
      .fieldset legend{font-weight:600}
      .row{display:grid;grid-template-columns:1fr 1fr;gap:.75rem}
    </style>
  </head>
  <body class="app">
    <main class="screen">
      <!-- Topbar -->
      <header class="topbar" role="banner">
        <button class="btn btn--ghost" onclick="history.back()" aria-label="Volver">‚Üê</button>
        <h1 class="topbar__title" style="flex: 1">EBECO</h1>
        <img src="assets/logo-ebeco.png" alt="Logo EBECO" class="brand__logo"
             style="width:80px;height:80px;object-fit:contain;border-radius:50%;background:transparent;box-shadow:none;" />
      </header>

      <!-- Card principal con formulario -->
      <section class="card u-grid stack-top" aria-labelledby="card-payment-title">
        <h2 id="card-payment-title">Pagar con tarjeta</h2>

        <form id="payment-form" class="u-grid" novalidate>
          <!-- Modo de pago -->
          <fieldset class="fieldset">
            <legend>Tipo de pago</legend>
            <label style="display:flex;gap:.5rem;align-items:center;margin:.25rem 0">
              <input type="radio" name="payMode" value="subscription" checked />
              <span>Suscripci√≥n mensual del plan</span>
            </label>
            <div id="planInfo" class="hint"></div>

            <label style="display:flex;gap:.5rem;align-items:center;margin:.5rem 0 .25rem">
              <input type="radio" name="payMode" value="single" />
              <span>Uso √∫nico (S/ 3 por hora)</span>
            </label>
            <div id="singleWrapper" class="row" style="display:none">
              <label>Horas de uso
                <input id="hours" type="number" min="1" step="1" value="1" />
              </label>
              <div class="hint" style="align-self:end">Se cobra solo por esta sesi√≥n.</div>
            </div>
          </fieldset>

          <div class="field">
            <label for="cardholder" class="label">Titular de la tarjeta</label>
            <input type="text" id="cardholder" name="cardholder" class="input" placeholder="Nombre completo" />
          </div>

          <div class="field">
            <label for="card-number" class="label">N√∫mero de tarjeta</label>
            <input type="text" id="card-number" name="card-number" class="input" placeholder="1234 5678 9012 3456" />
          </div>

          <div class="row">
            <div class="field">
              <label for="expiration" class="label">Fecha de vencimiento</label>
              <input type="month" id="expiration" name="expiration" class="input" />
            </div>

            <div class="field">
              <label for="cvv" class="label">CVV</label>
              <input type="text" id="cvv" name="cvv" class="input" placeholder="123" />
            </div>
          </div>

          <div class="field">
            <label for="total-amount" class="label">Monto a pagar</label>
            <input type="text" id="total-amount" name="total-amount" class="input" value="S/. 0.00" readonly />
          </div>

          <div class="actions" style="display:flex;flex-direction:column;gap:.75rem">
            <button id="btnSubmit" type="submit" class="btn btn--primary btn--lg">Confirmar pago</button>
            <button id="btnConnect" type="button" class="btn btn--ghost" style="display:none">Conectar dispositivo</button>
          </div>

          <div id="serialStatus" class="u-muted" style="margin-top:1rem;text-align:center">Preparando sistema‚Ä¶</div>
        </form>
      </section>
    </main>

    <script src="app.js"></script>
    <script>
      // ==========================
      //   C√°lculo de monto
      // ==========================
      const RATE_PER_HOUR = 3; // S/ 3 por hora
      const totalInput = document.getElementById("total-amount");
      const planInfo = document.getElementById("planInfo");
      const hoursEl = document.getElementById("hours");
      const singleWrapper = document.getElementById("singleWrapper");
      const payModeEls = Array.from(document.querySelectorAll('input[name="payMode"]'));

      // Lee plan actual del usuario o desde la URL (?plan=basico|estandar|premium)
      const PLANS = (window.EBECO?.getPlans && EBECO.getPlans()) || {
        basico:{name:"B√°sico",price:25}, estandar:{name:"Est√°ndar",price:35}, premium:{name:"Premium",price:45}
      };
      const qp = new URLSearchParams(location.search);
      const user = (window.EBECO?.getCurrentUser && EBECO.getCurrentUser()) || null;
      const planKeyFromURL = qp.get("plan");
      const planKey = (planKeyFromURL || user?.plan || "basico");
      const plan = PLANS[planKey];

      function format(n){ return "S/. " + n.toFixed(2); }

      function hydratePlanInfo(){
        if (plan) {
          planInfo.textContent = `Plan actual: ${plan.name} ‚Äî ${format(plan.price)}/mes`;
        } else {
          planInfo.textContent = "Elige un plan en la pantalla anterior.";
        }
      }

      function currentMode(){ return payModeEls.find(r=>r.checked)?.value || "subscription"; }

      function computeAmount(){
        let amount = 0;
        if (currentMode() === "subscription") {
          amount = plan ? plan.price : 0;
        } else {
          const h = Math.max(1, parseInt(hoursEl.value || "1", 10));
          amount = RATE_PER_HOUR * h;
        }
        totalInput.value = format(amount);
        totalInput.dataset.amount = String(amount);
        return amount;
      }

      payModeEls.forEach(radio=>{
        radio.addEventListener('change', ()=>{
          const single = currentMode()==="single";
          singleWrapper.style.display = single ? "grid" : "none";
          computeAmount();
        });
      });

      hoursEl?.addEventListener('input', computeAmount);

      hydratePlanInfo();
      computeAmount();

      // ==========================
      //   Web Serial (tu c√≥digo, intacto)
      // ==========================
      let port = null, writer = null, reader = null, textDecoder = null;
      let openPromise = null;
      let navTimer = null;

      const statusEl = document.getElementById("serialStatus");
      const btnConnect = document.getElementById("btnConnect");
      const form = document.getElementById("payment-form");
      const btnSubmit = document.getElementById("btnSubmit");

      function setStatus(t, tone = "muted") {
        statusEl.textContent = t;
        statusEl.style.color = tone === "ok" ? "#16a34a" : tone === "err" ? "#b91c1c" : "#64748b";
      }

      async function readLoop() {
        let buf = "";
        while (true) {
          const { value, done } = await reader.read();
          if (done) break;
          if (!value) continue;

          buf += textDecoder.decode(value);
          const lines = buf.split(/\r?\n/);
          buf = lines.pop() || "";

          for (const raw of lines) {
            const line = raw.trim();
            if (!line) continue;

            if (/OPEN/i.test(line)) {
              setStatus("Candado abierto (verde).", "ok");
              if (navTimer) { clearTimeout(navTimer); navTimer = null; }
              setTimeout(() => { window.location.href = "bicicleta-desbloqueada.html"; }, 300);
            }
            if (/CLOSE/i.test(line)) setStatus("Candado cerrado (rojo).");
          }
        }
      }

      async function sendLine(s) {
        if (!writer) throw new Error("No hay conexi√≥n.");
        const data = new TextEncoder().encode(s + "\n");
        await writer.write(data);
        console.log("[EBECO] >", s);
      }

      async function ensureConnected({ forceDialog = false } = {}) {
        if (!("serial" in navigator)) { setStatus("Web Serial no disponible (usa Chrome/Edge).", "err"); return false; }
        if (openPromise) { try { await openPromise; } catch {} return !!(port && port.readable && port.writable); }

        openPromise = (async () => {
          try {
            if (!port) {
              const ports = await navigator.serial.getPorts();
              if (ports.length) port = ports[0];
              else if (forceDialog) {
                const filters = [{usbVendorId:0x2341},{usbVendorId:0x2a03},{usbVendorId:0x1a86},{usbVendorId:0x10c4}];
                port = await navigator.serial.requestPort({ filters });
              } else {
                setStatus("Sin permiso previo. Pulsa ‚ÄúConectar dispositivo‚Äù.");
                btnConnect.style.display = "inline-block";
                return false;
              }
            }
            const needsOpen = !(port.readable && port.writable);
            if (needsOpen) {
              await port.open({ baudRate: 115200 });
              await new Promise(r=>setTimeout(r,1200));
              writer = port.writable.getWriter();
              textDecoder = new TextDecoder();
              reader = port.readable.getReader();
              readLoop().catch(()=>{});
            }
            setStatus("‚úÖ Sistema conectado.", "ok");
            btnConnect.style.display = "none";
            window.addEventListener("beforeunload", async () => {
              try { await reader?.cancel?.(); } catch {}
              try { reader?.releaseLock?.(); } catch {}
              try { writer?.releaseLock?.(); } catch {}
              try { await port?.close?.(); } catch {}
            }, { once:true });
            return true;
          } catch (e) {
            console.error("[EBECO] ensureConnected open error:", e);
            setStatus("No se pudo abrir el puerto. ¬øIDE u otra pesta√±a lo usa?", "err");
            port = null;
            return false;
          } finally { setTimeout(()=>{ openPromise = null; },0); }
        })();

        return await openPromise;
      }

      document.addEventListener("DOMContentLoaded", () => { ensureConnected(); });
      btnConnect.addEventListener("click", async () => {
        btnConnect.disabled = true;
        setStatus("Abriendo selector de puertos‚Ä¶");
        try {
          const filters=[{usbVendorId:0x2341},{usbVendorId:0x2a03},{usbVendorId:0x1a86},{usbVendorId:0x10c4}];
          port = await navigator.serial.requestPort({ filters });
          setStatus("Conectando al dispositivo‚Ä¶");
          const ok = await ensureConnected();
          if (ok) {
            const info = port.getInfo?.() || {};
            setStatus(`‚úÖ Conectado (vendor 0x${(info.usbVendorId||0).toString(16)} product 0x${(info.usbProductId||0).toString(16)})`, "ok");
            btnConnect.style.display="none";
          } else {
            setStatus("No se pudo conectar. Verifica el IDE.", "err");
            btnConnect.disabled=false;
          }
        } catch(e) {
          setStatus("Selecci√≥n cancelada. Vuelve a intentar.", "muted");
          btnConnect.disabled=false;
        }
      });

      // ==========================
      //   Submit: cobra y abre
      // ==========================
      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        btnSubmit.disabled = true;

        // 1) Calcula y "cobra"
        const amount = computeAmount();
        const mode = currentMode();

        // Si es suscripci√≥n, marcar activa
        if (mode === "subscription") {
          try { window.EBECO?.markPaymentOk?.(); } catch {}
        }

        // 2) Conectar y abrir
        setStatus("Conectando al dispositivo‚Ä¶");
        let ok = await ensureConnected();
        if (!ok) ok = await ensureConnected({ forceDialog: true });
        if (!ok) { setStatus("No se pudo conectar. Usa ‚ÄúConectar dispositivo‚Äù.", "err"); btnSubmit.disabled=false; return; }

        setStatus(`Procesando pago de ${totalInput.value}‚Ä¶`);
        await new Promise(r=>setTimeout(r, 600)); // simulaci√≥n de cobro

        setStatus("üîì Abriendo seguro‚Ä¶");
        try { await sendLine("o"); }
        catch { setStatus("No se pudo enviar el comando. Cierra el Monitor Serial del IDE.", "err"); btnSubmit.disabled=false; return; }

        if (navTimer) clearTimeout(navTimer);
        navTimer = setTimeout(()=>{ window.location.href = "bicicleta-desbloqueada.html"; }, 1500);

        setTimeout(()=>{ btnSubmit.disabled=false; }, 2000);
      });
    </script>
  </body>
</html>
